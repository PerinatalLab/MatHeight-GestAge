---
title: "Simulation for Height-GestAge study"
author: "Jonas Bacelis"
date: "9/26/2017"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load helper functions:
source("~/Dropbox/GIT/SEMFR_HEIGHT-GESTAGE/2017/simulation_functions.R")
# set parameters:
n_ind = 2000    # number of pregnancies to simulate
#set.seed(1111)  # reproducibility
fgr_centr = 10   # the mean of fetal growth rate distribution (cm3/d)
fgr_extrm = 0.7 # fraction of all fetal growths that will be considered extreme (LGA and SGA)
fgr_indep = 5   # independence of fetal growth rate from MH and MUS (1=correlated,10=independent)
mhs_centr = 160 # the mean of maternal height distribution (cm)
mhs_spred = 10  # the spread (SD) of maternal height distribution (cm)
mus_centr = fgr_centr*280  # mean of of maternal uterine size distribution
mus_spred = 100 # the variance of maternal uterine size
```

### Starting variables

```{r,echo=F,warning=F,message=FALSE,fig.height = 5, fig.width = 5,fig.align="center"}
library(GGally)
library(ggplot2)

        ### generate source for bimodal continuous (extreme) fetal growth values:
        #fgr_extrm = fraction of all fetal growths that will be considered extreme
        ps1 = seq(from = 1/n_ind,     to = fgr_extrm/2, length.out = floor(n_ind/2))
        ps2 = seq(from = 1-fgr_extrm/2, to = 1-1/n_ind, length.out = floor(n_ind/2))
        fgr_src = qnorm(p = c(ps1,ps2),mean = fgr_centr, sd=  0.4)  #fetal growth rate (g/day)
        fgr_src = sample(fgr_src,size = length(fgr_src),replace = F) # shuffle
        
        # generate source for maternal height values
        mhs_src = rnorm(n_ind,mean=mhs_centr,sd=mhs_spred)  # maternal heights
        
        # generate source for maternal uterine size values
        mus_src = rnorm(n_ind,mean=mus_centr,sd=mus_spred)  # maternal uterine size
        
        # generate helper (genetic/confoudning) variable
        hlp = rnorm(n_ind) # "source"
        hlp1 = hlp + rnorm(n_ind)       # "offspring"  -> MHS
        hlp2 = hlp + rnorm(n_ind)       # "offspring"  -> MUS
        hlp3 = hlp + rnorm(n_ind,sd=fgr_indep)  # "offspring"  -> FGR
        # maternal height values
        rnk = match(rank(mhs_src),rank(hlp1))
        mhs = mhs_src[order(rnk)]; rm(rnk)
        # maternal uterine size values
        rnk = match(rank(mus_src),rank(hlp2))
        mus = mus_src[order(rnk)]; rm(rnk)
        # fetal growth rate values
        rnk = match(rank(fgr_src),rank(hlp3))
        fgr = fgr_src[order(rnk)]; rm(rnk)
        ### cleanup
        rm(hlp,hlp1,hlp2,hlp3)
        
sta = as.numeric(fgr>median(fgr))  # 0 = SGA, 1 = LGA
tmp = data.frame(mhs,mus,fgr,stringsAsFactors = F)
ggpairs(tmp)
```
**fgr** is fetal growth rate, **mus** is maternal uterine size, **mh** is maternal height. **fgr** has a bimodal distribution (LGA and SGA fetuses). **mh** and **mus** are strongly correlated. **fgr** is a little correlated with **mh** and **mus**.

### Causes of birth (baseline vs interaction)

```{r,echo=F,warning=F,message=FALSE,fig.height = 3, fig.width = 7,fig.align="center"}
library(GGally)
library(ggplot2)
# baseline scenario (only)
gas0 = fun_generateGestAge(fgr=1,mus=rep(1,n_ind),interactionRisk = F,baselineRisk = T)
plot_data  = data.frame(time=gas0,cause="baseline",stringsAsFactors = F)
# interaction scenario (only)
gas1 = fun_generateGestAge(fgr,mus,interactionRisk = T,baselineRisk = F)
tmp  = data.frame(time=gas1,cause="MHxFGR",stringsAsFactors = F)
plot_data = rbind(plot_data,tmp); rm(tmp)

#plot_data = plot_data[order(plot_data$gr),]
plot_data$cause = factor(plot_data$cause,levels = unique(plot_data$cause))
obj = ggplot(plot_data, aes(x=time, fill=cause)) + geom_histogram(alpha=0.5, bins=50, position="identity")
print(obj)
```

\newpage

### Plot the interaction

```{r, echo=F,warning=F,message=FALSE,fig.height = 6, fig.width = 6,fig.align="center"}
gas = fun_generateGestAge(fgr,mus,interactionRisk = T,baselineRisk = T)
mod = lm(gas ~ mhs*sta)
fun_interactionPlots(mod,mhs,sta,gas,1)
cfs = as.data.frame(coef(summary(mod)))
# convert p-values to symbols
ps = as.numeric(cfs[,4])
t1 = which( ps<=0.000001)
t2 = which((ps> 0.000001)&(ps<=0.00001))
t3 = which((ps> 0.00001)&(ps<=0.0001))
t4 = which((ps> 0.0001)&(ps<=0.001))
t5 = which((ps> 0.001)&(ps<=0.01))
t6 = which((ps> 0.01)&(ps<=0.05))
t7 = which( ps> 0.05)
cfs$significance = NA
cfs$significance[t1] = "*****"
cfs$significance[t2] = "****"
cfs$significance[t3] = "***"
cfs$significance[t4] = "**"
cfs$significance[t5] = "*"
cfs$significance[t6] = "."
cfs$significance[t7] = ""
cfs[,1:3] = round(cfs[,1:3],2)

library(knitr)
kable(cfs,format = "markdown",align = "c")

```

In the figure above, fetuses with slow growth (SGA) are shown in black circles, while fetuses with fast growth (LGA) are shown in red circles. The blue and orange lines represent a linear model for SGA and LGA pregnancies respectively.

### Conclusion

The simulated interaction pattern closely resembles the empirical interaction pattern (detected in the real-life data): (**1**) positive effect of height on birth timing in both types of pregnancies; (**2**) larger effect size of height on birth timing in pregnancies with faster-growing fetuses than in slow-growing fetuses.

The prerequisites for this simulation were:
* Maternal height is correlated with maternal uterine size
* 
*

Some assumtions were
* imposed dependencies (corelations) are linear
*
*

### TEMPORARY
```{r}
# when only interaction is at work
types = rep(NA,n_ind) # type of pregnancy
t1 = ((fgr>=median(fgr))&(mus>=median(mus)))
t2 = ((fgr<median(fgr))&(mus<median(mus)))
t3 = ((fgr>=median(fgr))&(mus<median(mus)))
t4 = ((fgr<median(fgr))&(mus>=median(mus)))
types[t1] = "LGA-tall"
types[t2] = "SGA-short"
types[t3] = "LGA-short"
types[t4] = "SGA-tall"
dtf = data.frame(gas1,types,stringsAsFactors = F)
ggplot(dtf, aes(gas1, fill = types)) + geom_histogram(bins=10) #show.legend = FALSE,

# when only baseline is at work
types = rep(NA,n_ind) # type of pregnancy
t1 = ((fgr>=median(fgr))&(mus>=median(mus)))
t2 = ((fgr<median(fgr))&(mus<median(mus)))
t3 = ((fgr>=median(fgr))&(mus<median(mus)))
t4 = ((fgr<median(fgr))&(mus>=median(mus)))
types[t1] = "LGA-tall"
types[t2] = "SGA-short"
types[t3] = "LGA-short"
types[t4] = "SGA-tall"
dtf = data.frame(gas0,types,stringsAsFactors = F)
ggplot(dtf, aes(gas0, fill = types)) + geom_histogram(bins=10) #show.legend = FALSE,

# when interaction is at work together with baseline
types = rep(NA,n_ind) # type of pregnancy
t1 = ((fgr>=median(fgr))&(mus>=median(mus)))
t2 = ((fgr<median(fgr))&(mus<median(mus)))
t3 = ((fgr>=median(fgr))&(mus<median(mus)))
t4 = ((fgr<median(fgr))&(mus>=median(mus)))
types[t1] = "LGA-tall"
types[t2] = "SGA-short"
types[t3] = "LGA-short"
types[t4] = "SGA-tall"
dtf = data.frame(gas,types,stringsAsFactors = F)
ggplot(dtf, aes(gas, fill = types)) + geom_histogram(bins=10) #show.legend = FALSE,


```
